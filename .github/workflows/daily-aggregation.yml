name: Daily Host Aggregation

on:
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    outputs:
      timestamped_filename: ${{ steps.find-files.outputs.timestamped_csv_filename }}
          
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for all branches

    - name: Install dependencies
      run: |
        sudo apt-get update && sudo apt-get install -y python3 python3-pip
        python3 -m pip install --upgrade pip
        pip3 install -r requirements.txt
    
    - name: Run host aggregation script
      run: |
        python3 host_aggregator.py
    
    - name: Find generated files
      id: find-files
      run: |
        # Find the timestamped CSV file (most recent)
        TIMESTAMPED_CSV=$(find data/ -name "host_entries_*.csv" -type f | sort -r | head -n 1)
        LATEST_CSV="data/latest.csv"
        
        # Find the timestamped JSON file (most recent)
        TIMESTAMPED_JSON=$(find data/ -name "host_entries_*.json" -type f | sort -r | head -n 1)
        LATEST_JSON="data/latest.json"
        
        # Find the timestamped YAML file (most recent)
        TIMESTAMPED_YAML=$(find data/ -name "host_entries_*.yaml" -type f | sort -r | head -n 1)
        LATEST_YAML="data/latest.yaml"
        
        if [ -z "$TIMESTAMPED_CSV" ]; then
          echo "Error: No timestamped CSV file found"
          exit 1
        fi
        
        if [ ! -f "$LATEST_CSV" ]; then
          echo "Error: latest.csv file not found"
          exit 1
        fi
        
        if [ -z "$TIMESTAMPED_JSON" ]; then
          echo "Error: No timestamped JSON file found"
          exit 1
        fi
        
        if [ ! -f "$LATEST_JSON" ]; then
          echo "Error: latest.json file not found"
          exit 1
        fi
        
        if [ -z "$TIMESTAMPED_YAML" ]; then
          echo "Error: No timestamped YAML file found"
          exit 1
        fi
        
        if [ ! -f "$LATEST_YAML" ]; then
          echo "Error: latest.yaml file not found"
          exit 1
        fi
        
        # Extract filename without path
        TIMESTAMPED_CSV_FILENAME=$(basename "$TIMESTAMPED_CSV")
        TIMESTAMPED_JSON_FILENAME=$(basename "$TIMESTAMPED_JSON")
        TIMESTAMPED_YAML_FILENAME=$(basename "$TIMESTAMPED_YAML")
        
        echo "timestamped_csv=$TIMESTAMPED_CSV" >> $GITHUB_OUTPUT
        echo "timestamped_csv_filename=$TIMESTAMPED_CSV_FILENAME" >> $GITHUB_OUTPUT
        echo "latest_csv=$LATEST_CSV" >> $GITHUB_OUTPUT
        
        echo "timestamped_json=$TIMESTAMPED_JSON" >> $GITHUB_OUTPUT
        echo "timestamped_json_filename=$TIMESTAMPED_JSON_FILENAME" >> $GITHUB_OUTPUT
        echo "latest_json=$LATEST_JSON" >> $GITHUB_OUTPUT
        
        echo "timestamped_yaml=$TIMESTAMPED_YAML" >> $GITHUB_OUTPUT
        echo "timestamped_yaml_filename=$TIMESTAMPED_YAML_FILENAME" >> $GITHUB_OUTPUT
        echo "latest_yaml=$LATEST_YAML" >> $GITHUB_OUTPUT
        
        echo "Found timestamped CSV: $TIMESTAMPED_CSV"
        echo "Found latest CSV: $LATEST_CSV"
        echo "Found timestamped JSON: $TIMESTAMPED_JSON"
        echo "Found latest JSON: $LATEST_JSON"
        echo "Found timestamped YAML: $TIMESTAMPED_YAML"
        echo "Found latest YAML: $LATEST_YAML"
        
    - name: Commit generated files to hosts branch
      run: |
        BRANCH_NAME="hosts"
        
        # Checkout hosts branch to commit changes to it
        git checkout $BRANCH_NAME
        
        # Create data/csv directory if it doesn't exist
        mkdir -p data/csv
        
        # Create data/json directory if it doesn't exist
        mkdir -p data/json

        # Create data/yaml directory if it doesn't exist
        mkdir -p data/yaml
        
        # Move CSV files to data/csv directory
        mv ${{ steps.find-files.outputs.latest_csv }} data/csv/latest.csv
        mv ${{ steps.find-files.outputs.timestamped_csv }} data/csv/${{ steps.find-files.outputs.timestamped_csv_filename }}
        
        # Move JSON files to data/json directory
        mv ${{ steps.find-files.outputs.latest_json }} data/json/latest.json
        mv ${{ steps.find-files.outputs.timestamped_json }} data/json/${{ steps.find-files.outputs.timestamped_json_filename }}
        
        # Move YAML files to data/yaml directory
        mv ${{ steps.find-files.outputs.latest_yaml }} data/yaml/latest.yaml
        mv ${{ steps.find-files.outputs.timestamped_yaml }} data/yaml/${{ steps.find-files.outputs.timestamped_yaml_filename }}
                
        # Configure git user
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Add files from data directories
        git add data/csv/ data/json/ data/yaml/
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          # Commit the changes
          git commit -m "Update files: ${{ steps.find-files.outputs.timestamped_csv_filename }}"
          
          # Push to hosts branch
          git push origin $BRANCH_NAME
          echo "Committed and pushed files to hosts branch"
        fi
        
        # Switch back to main branch for subsequent steps
        git checkout main
    
    - name: Prepare Pages deployment
      # This step runs automatically via GitHub Actions (not locally)
      # It prepares the CSV files for GitHub Pages deployment
      run: |
        # Checkout hosts branch to get the committed CSV files
        git checkout hosts
        
        # Create build directory structure
        mkdir -p build
        
        # Copy entire data/ directory from hosts branch to build directory
        cp -r data build/
        
        echo "Prepared files for GitHub Pages deployment from hosts branch"
    
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './build'
    
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Display completion information
        run: |
          {
            echo "## Host Aggregation Complete"
            echo ""
            echo "### CSV Files Generated:"
            echo "- **Latest CSV**: \`data/csv/latest.csv\`"
            echo "- **Timestamped CSV**: \`data/csv/${{ needs.build.outputs.timestamped_filename }}\`"
            echo ""
            echo "### GitHub Pages URLs:"
            echo "- **Latest CSV**: \`${{ steps.deployment.outputs.page_url }}data/csv/latest.csv\`"
            echo "- **Timestamped CSV**: \`${{ steps.deployment.outputs.page_url }}data/csv/${{ needs.build.outputs.timestamped_filename }}\`"
            echo ""
            echo "Files have been deployed to GitHub Pages and are now accessible."
          } >> $GITHUB_STEP_SUMMARY